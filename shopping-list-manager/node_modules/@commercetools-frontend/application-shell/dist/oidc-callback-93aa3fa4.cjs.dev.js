'use strict';

var _URL = require('@babel/runtime-corejs3/core-js-stable/url');
var jwtDecode = require('jwt-decode');
var qss = require('qss');
var reactRouterDom = require('react-router-dom');
var applicationShellConnectors = require('@commercetools-frontend/application-shell-connectors');
var redirector = require('./redirector-5daa8baa.cjs.dev.js');
var _styled = require('@emotion/styled/base');
var applicationComponents = require('@commercetools-frontend/application-components');
var FailedAuthenticationSVG = require('@commercetools-frontend/assets/images/doors-closed.svg');
var i18n = require('@commercetools-frontend/i18n');
var Card = require('@commercetools-uikit/card');
var Constraints = require('@commercetools-uikit/constraints');
var designSystem = require('@commercetools-uikit/design-system');
var FlatButton = require('@commercetools-uikit/flat-button');
var icons = require('@commercetools-uikit/icons');
var notifications = require('@commercetools-uikit/notifications');
var Spacings = require('@commercetools-uikit/spacings');
var Text = require('@commercetools-uikit/text');
var dist_commercetoolsFrontendApplicationShell = require('./index-9c9f0152.cjs.dev.js');
var jsxRuntime = require('@emotion/react/jsx-runtime');
require('@babel/runtime-corejs3/core-js-stable/object/keys');
require('@babel/runtime-corejs3/core-js-stable/object/get-own-property-symbols');
require('@babel/runtime-corejs3/core-js-stable/instance/filter');
require('@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptor');
require('@babel/runtime-corejs3/core-js-stable/instance/for-each');
require('@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptors');
require('@babel/runtime-corejs3/core-js-stable/object/define-properties');
require('@babel/runtime-corejs3/core-js-stable/object/define-property');
require('@babel/runtime-corejs3/helpers/defineProperty');
require('prop-types');
require('react');
require('./use-is-served-by-proxy-ed411f45.cjs.dev.js');
require('./index-37a25e51.cjs.dev.js');
require('@babel/runtime-corejs3/helpers/slicedToArray');
require('@babel/runtime-corejs3/core-js-stable/instance/reduce');
require('@babel/runtime-corejs3/core-js-stable/object/entries');
require('@babel/runtime-corejs3/core-js-stable/reflect/has');
require('@reduxjs/toolkit');
require('lodash/mapValues');
require('omit-empty-es');
require('redux-thunk');
require('@commercetools-frontend/constants');
require('@commercetools-frontend/notifications');
require('@commercetools-frontend/sdk');
require('@babel/runtime-corejs3/core-js-stable/instance/index-of');
require('@babel/runtime-corejs3/core-js-stable/instance/slice');
require('@babel/runtime-corejs3/core-js-stable/instance/includes');
require('@commercetools-frontend/sentry');
require('@commercetools-frontend/react-notifications');
require('@babel/runtime-corejs3/core-js-stable/instance/starts-with');
require('redux-logger');
require('@babel/runtime-corejs3/core-js-stable/instance/find');
require('@babel/runtime-corejs3/core-js-stable/array/is-array');
require('@emotion/react');
require('./oidc-7c48215c.cjs.dev.js');
require('@babel/runtime-corejs3/core-js-stable/instance/concat');
require('@babel/runtime-corejs3/core-js-stable/instance/map');
require('react-intl');
require('@babel/runtime-corejs3/helpers/taggedTemplateLiteral');
require('@babel/runtime-corejs3/helpers/objectDestructuringEmpty');
require('@babel/runtime-corejs3/helpers/extends');
require('memoize-one');
require('react-select');
require('@commercetools-uikit/accessible-hidden');
require('@commercetools-uikit/select-input');
require('@commercetools-frontend/assets/images/ct-logo.svg');
require('@commercetools-uikit/loading-spinner');
require('@commercetools-frontend/browser-history');
require('@commercetools-frontend/l10n');
require('@babel/runtime-corejs3/core-js-stable/reflect/construct');
require('@babel/runtime-corejs3/helpers/classCallCheck');
require('@babel/runtime-corejs3/helpers/createClass');
require('@babel/runtime-corejs3/helpers/inherits');
require('@babel/runtime-corejs3/helpers/possibleConstructorReturn');
require('@babel/runtime-corejs3/helpers/getPrototypeOf');
require('@babel/runtime-corejs3/core-js-stable/object/from-entries');
require('@babel/runtime-corejs3/core-js-stable/instance/flags');
require('@apollo/client/react');
require('@flopflip/combine-adapters');
require('@flopflip/http-adapter');
require('@flopflip/launchdarkly-adapter');
require('@flopflip/react-broadcast');
require('react-redux');
require('lodash/upperFirst');
require('@commercetools-uikit/design-system/materials/resets.css');
require('@commercetools-frontend/application-config/ssr');
require('@commercetools-frontend/permissions');
require('@babel/runtime-corejs3/core-js-stable/json/stringify');
require('@babel/runtime-corejs3/core-js-stable/instance/some');
require('@commercetools-frontend/actions-global');

function _interopDefault (e) { return e && e.__esModule ? e : { 'default': e }; }

var _URL__default = /*#__PURE__*/_interopDefault(_URL);
var jwtDecode__default = /*#__PURE__*/_interopDefault(jwtDecode);
var _styled__default = /*#__PURE__*/_interopDefault(_styled);
var FailedAuthenticationSVG__default = /*#__PURE__*/_interopDefault(FailedAuthenticationSVG);
var Card__default = /*#__PURE__*/_interopDefault(Card);
var Constraints__default = /*#__PURE__*/_interopDefault(Constraints);
var FlatButton__default = /*#__PURE__*/_interopDefault(FlatButton);
var Spacings__default = /*#__PURE__*/_interopDefault(Spacings);
var Text__default = /*#__PURE__*/_interopDefault(Text);

const Divider = /*#__PURE__*/_styled__default["default"]("div", process.env.NODE_ENV === "production" ? {
  target: "e57nw7s0"
} : {
  target: "e57nw7s0",
  label: "Divider"
})("box-sizing:border-box;width:100%;margin:0;border:0;border-style:solid;border-top-width:1px;border-top-color:", designSystem.customProperties.colorNeutral, ";" + (process.env.NODE_ENV === "production" ? "" : "/*# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm9pZGMtY2FsbGJhY2stZXJyb3ItcGFnZS50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBOEIwQiIsImZpbGUiOiJvaWRjLWNhbGxiYWNrLWVycm9yLXBhZ2UudHN4Iiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHN0eWxlZCBmcm9tICdAZW1vdGlvbi9zdHlsZWQnO1xuaW1wb3J0IHsgdXNlSGlzdG9yeSB9IGZyb20gJ3JlYWN0LXJvdXRlci1kb20nO1xuaW1wb3J0IHtcbiAgUHVibGljUGFnZUxheW91dCxcbiAgdGhlbWVzT3ZlcnJpZGVzLFxufSBmcm9tICdAY29tbWVyY2V0b29scy1mcm9udGVuZC9hcHBsaWNhdGlvbi1jb21wb25lbnRzJztcbmltcG9ydCBGYWlsZWRBdXRoZW50aWNhdGlvblNWRyBmcm9tICdAY29tbWVyY2V0b29scy1mcm9udGVuZC9hc3NldHMvaW1hZ2VzL2Rvb3JzLWNsb3NlZC5zdmcnO1xuaW1wb3J0IHR5cGUgeyBUQXN5bmNMb2NhbGVEYXRhUHJvcHMgfSBmcm9tICdAY29tbWVyY2V0b29scy1mcm9udGVuZC9pMThuJztcblxuaW1wb3J0IHsgQXN5bmNMb2NhbGVEYXRhIH0gZnJvbSAnQGNvbW1lcmNldG9vbHMtZnJvbnRlbmQvaTE4bic7XG5pbXBvcnQgQ2FyZCBmcm9tICdAY29tbWVyY2V0b29scy11aWtpdC9jYXJkJztcbmltcG9ydCBDb25zdHJhaW50cyBmcm9tICdAY29tbWVyY2V0b29scy11aWtpdC9jb25zdHJhaW50cyc7XG5pbXBvcnQge1xuICBUaGVtZVByb3ZpZGVyLFxuICBjdXN0b21Qcm9wZXJ0aWVzLFxufSBmcm9tICdAY29tbWVyY2V0b29scy11aWtpdC9kZXNpZ24tc3lzdGVtJztcbmltcG9ydCBGbGF0QnV0dG9uIGZyb20gJ0Bjb21tZXJjZXRvb2xzLXVpa2l0L2ZsYXQtYnV0dG9uJztcbmltcG9ydCB7IEFuZ2xlTGVmdEljb24gfSBmcm9tICdAY29tbWVyY2V0b29scy11aWtpdC9pY29ucyc7XG5pbXBvcnQgeyBDb250ZW50Tm90aWZpY2F0aW9uIH0gZnJvbSAnQGNvbW1lcmNldG9vbHMtdWlraXQvbm90aWZpY2F0aW9ucyc7XG5pbXBvcnQgU3BhY2luZ3MgZnJvbSAnQGNvbW1lcmNldG9vbHMtdWlraXQvc3BhY2luZ3MnO1xuaW1wb3J0IFRleHQgZnJvbSAnQGNvbW1lcmNldG9vbHMtdWlraXQvdGV4dCc7XG5pbXBvcnQgQ29uZmlndXJlSW50bFByb3ZpZGVyIGZyb20gJy4uL2NvbmZpZ3VyZS1pbnRsLXByb3ZpZGVyJztcblxudHlwZSBUUHJvcHMgPSB7XG4gIG1lc3NhZ2U6IHN0cmluZztcbiAgbG9jYWxlOiBzdHJpbmc7XG4gIGFwcGxpY2F0aW9uTWVzc2FnZXM6IFRBc3luY0xvY2FsZURhdGFQcm9wc1snYXBwbGljYXRpb25NZXNzYWdlcyddO1xuICBjaGlsZHJlbj86IG5ldmVyO1xufTtcblxuY29uc3QgRGl2aWRlciA9IHN0eWxlZC5kaXZgXG4gIGJveC1zaXppbmc6IGJvcmRlci1ib3g7XG4gIHdpZHRoOiAxMDAlO1xuICBtYXJnaW46IDA7XG4gIGJvcmRlcjogMDtcbiAgYm9yZGVyLXN0eWxlOiBzb2xpZDtcbiAgYm9yZGVyLXRvcC13aWR0aDogMXB4O1xuICBib3JkZXItdG9wLWNvbG9yOiAke2N1c3RvbVByb3BlcnRpZXMuY29sb3JOZXV0cmFsfTtcbmA7XG5cbmNvbnN0IEF1dGhDYWxsYmFja0Vycm9yUGFnZSA9IChwcm9wczogVFByb3BzKSA9PiB7XG4gIGNvbnN0IGhpc3RvcnkgPSB1c2VIaXN0b3J5KCk7XG4gIHJldHVybiAoXG4gICAgPEFzeW5jTG9jYWxlRGF0YVxuICAgICAgbG9jYWxlPXtwcm9wcy5sb2NhbGV9XG4gICAgICBhcHBsaWNhdGlvbk1lc3NhZ2VzPXtwcm9wcy5hcHBsaWNhdGlvbk1lc3NhZ2VzfVxuICAgID5cbiAgICAgIHsoeyBsb2NhbGUsIG1lc3NhZ2VzIH0pID0+IChcbiAgICAgICAgPENvbmZpZ3VyZUludGxQcm92aWRlciBsb2NhbGU9e2xvY2FsZX0gbWVzc2FnZXM9e21lc3NhZ2VzfT5cbiAgICAgICAgICA8VGhlbWVQcm92aWRlclxuICAgICAgICAgICAgdGhlbWU9XCJkZWZhdWx0XCJcbiAgICAgICAgICAgIHRoZW1lT3ZlcnJpZGVzPXt0aGVtZXNPdmVycmlkZXMuZGVmYXVsdH1cbiAgICAgICAgICAvPlxuICAgICAgICAgIDxQdWJsaWNQYWdlTGF5b3V0IGNvbnRlbnRTY2FsZT1cIndpZGVcIj5cbiAgICAgICAgICAgIDxTcGFjaW5ncy5JbmxpbmUganVzdGlmeUNvbnRlbnQ9XCJjZW50ZXJcIj5cbiAgICAgICAgICAgICAgPENvbnN0cmFpbnRzLkhvcml6b250YWwgbWF4PXsxMX0+XG4gICAgICAgICAgICAgICAgPENhcmQgaW5zZXRTY2FsZT1cInhsXCI+XG4gICAgICAgICAgICAgICAgICA8U3BhY2luZ3MuU3RhY2sgc2NhbGU9XCJsXCI+XG4gICAgICAgICAgICAgICAgICAgIDxTcGFjaW5ncy5JbmxpbmUganVzdGlmeUNvbnRlbnQ9XCJjZW50ZXJcIj5cbiAgICAgICAgICAgICAgICAgICAgICA8aW1nXG4gICAgICAgICAgICAgICAgICAgICAgICBzcmM9e0ZhaWxlZEF1dGhlbnRpY2F0aW9uU1ZHfVxuICAgICAgICAgICAgICAgICAgICAgICAgYWx0PVwiRmFpbGVkIGF1dGhlbnRpY2F0aW9uXCJcbiAgICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgICA8L1NwYWNpbmdzLklubGluZT5cbiAgICAgICAgICAgICAgICAgICAgPFRleHQuSGVhZGxpbmUgYXM9XCJoMlwiPlxuICAgICAgICAgICAgICAgICAgICAgIHsnQXV0aGVudGljYXRpb24gZXJyb3InfVxuICAgICAgICAgICAgICAgICAgICA8L1RleHQuSGVhZGxpbmU+XG4gICAgICAgICAgICAgICAgICAgIDxDb250ZW50Tm90aWZpY2F0aW9uIHR5cGU9XCJlcnJvclwiPlxuICAgICAgICAgICAgICAgICAgICAgIDxTcGFjaW5ncy5TdGFjayBzY2FsZT1cIm1cIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxUZXh0LkJvZHk+e3Byb3BzLm1lc3NhZ2V9PC9UZXh0LkJvZHk+XG4gICAgICAgICAgICAgICAgICAgICAgPC9TcGFjaW5ncy5TdGFjaz5cbiAgICAgICAgICAgICAgICAgICAgPC9Db250ZW50Tm90aWZpY2F0aW9uPlxuICAgICAgICAgICAgICAgICAgICA8U3BhY2luZ3MuU3RhY2sgc2NhbGU9XCJtXCI+XG4gICAgICAgICAgICAgICAgICAgICAgPERpdmlkZXIgLz5cbiAgICAgICAgICAgICAgICAgICAgICA8RmxhdEJ1dHRvblxuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw9XCJUcnkgbG9nIGluIGFnYWluXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIGljb249ezxBbmdsZUxlZnRJY29uIC8+fVxuICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17KCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICBoaXN0b3J5LnB1c2goJy8nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICAgICAgPC9TcGFjaW5ncy5TdGFjaz5cbiAgICAgICAgICAgICAgICAgIDwvU3BhY2luZ3MuU3RhY2s+XG4gICAgICAgICAgICAgICAgPC9DYXJkPlxuICAgICAgICAgICAgICA8L0NvbnN0cmFpbnRzLkhvcml6b250YWw+XG4gICAgICAgICAgICA8L1NwYWNpbmdzLklubGluZT5cbiAgICAgICAgICA8L1B1YmxpY1BhZ2VMYXlvdXQ+XG4gICAgICAgIDwvQ29uZmlndXJlSW50bFByb3ZpZGVyPlxuICAgICAgKX1cbiAgICA8L0FzeW5jTG9jYWxlRGF0YT5cbiAgKTtcbn07XG5BdXRoQ2FsbGJhY2tFcnJvclBhZ2UuZGlzcGxheU5hbWUgPSAnQXV0aENhbGxiYWNrRXJyb3JQYWdlJztcblxuZXhwb3J0IGRlZmF1bHQgQXV0aENhbGxiYWNrRXJyb3JQYWdlO1xuIl19 */"));
const AuthCallbackErrorPage = props => {
  const history = reactRouterDom.useHistory();
  return jsxRuntime.jsx(i18n.AsyncLocaleData, {
    locale: props.locale,
    applicationMessages: props.applicationMessages,
    children: _ref => {
      let locale = _ref.locale,
        messages = _ref.messages;
      return jsxRuntime.jsxs(dist_commercetoolsFrontendApplicationShell.ConfigureIntlProvider, {
        locale: locale,
        messages: messages,
        children: [jsxRuntime.jsx(designSystem.ThemeProvider, {
          theme: "default",
          themeOverrides: applicationComponents.themesOverrides.default
        }), jsxRuntime.jsx(applicationComponents.PublicPageLayout, {
          contentScale: "wide",
          children: jsxRuntime.jsx(Spacings__default["default"].Inline, {
            justifyContent: "center",
            children: jsxRuntime.jsx(Constraints__default["default"].Horizontal, {
              max: 11,
              children: jsxRuntime.jsx(Card__default["default"], {
                insetScale: "xl",
                children: jsxRuntime.jsxs(Spacings__default["default"].Stack, {
                  scale: "l",
                  children: [jsxRuntime.jsx(Spacings__default["default"].Inline, {
                    justifyContent: "center",
                    children: jsxRuntime.jsx("img", {
                      src: FailedAuthenticationSVG__default["default"],
                      alt: "Failed authentication"
                    })
                  }), jsxRuntime.jsx(Text__default["default"].Headline, {
                    as: "h2",
                    children: 'Authentication error'
                  }), jsxRuntime.jsx(notifications.ContentNotification, {
                    type: "error",
                    children: jsxRuntime.jsx(Spacings__default["default"].Stack, {
                      scale: "m",
                      children: jsxRuntime.jsx(Text__default["default"].Body, {
                        children: props.message
                      })
                    })
                  }), jsxRuntime.jsxs(Spacings__default["default"].Stack, {
                    scale: "m",
                    children: [jsxRuntime.jsx(Divider, {}), jsxRuntime.jsx(FlatButton__default["default"], {
                      label: "Try log in again",
                      icon: jsxRuntime.jsx(icons.AngleLeftIcon, {}),
                      onClick: () => {
                        history.push('/');
                      }
                    })]
                  })]
                })
              })
            })
          })
        })]
      });
    }
  });
};
AuthCallbackErrorPage.displayName = 'AuthCallbackErrorPage';

const OidcCallback = props => {
  const location = reactRouterDom.useLocation();
  let errorMessage;
  const fragments = qss.decode(location.hash.substring(1));

  // Validate the nonce (coming as a `state` parameter)
  // By trying to load the related session state, we can implicitly check if the nonce is correct or not.
  const sessionState = applicationShellConnectors.oidcStorage.getSessionState(fragments.state);
  const sessionToken = fragments.sessionToken;
  let decodedSessionToken;
  try {
    if (sessionToken) {
      decodedSessionToken = jwtDecode__default["default"](sessionToken);
    } else {
      errorMessage = 'Invalid client session (missing sessionToken)';
    }
  } catch (err) {
    if (err instanceof Error) {
      errorMessage = err.message;
    } else {
      errorMessage = 'Unknown error';
    }
  }
  if (!errorMessage) {
    var _decodedSessionToken;
    const hasValidSessionId = ((_decodedSessionToken = decodedSessionToken) === null || _decodedSessionToken === void 0 ? void 0 : _decodedSessionToken.nonce) === fragments.state;
    const hasValidApplicationId = window.app.applicationId === (sessionState === null || sessionState === void 0 ? void 0 : sessionState.applicationId);
    if (!sessionState || !hasValidSessionId || !hasValidApplicationId) {
      errorMessage = 'Invalid client session';
    }
  }
  if (errorMessage) {
    return jsxRuntime.jsx(AuthCallbackErrorPage, {
      message: errorMessage,
      locale: props.locale,
      applicationMessages: props.applicationMessages
    });
  }
  applicationShellConnectors.oidcStorage.setActiveSession(sessionToken);
  if (sessionState !== null && sessionState !== void 0 && sessionState.query.redirectTo) {
    try {
      const redirectToUrl = new _URL__default["default"](sessionState.query.redirectTo);
      return jsxRuntime.jsx(redirector.Redirector, {
        to: redirectToUrl.pathname
      });
    } catch (error) {
      console.warn("Invalid \"redirectTo\" URL", sessionState.query.redirectTo);
      // ignore
    }
  }

  return jsxRuntime.jsx(redirector.Redirector, {
    to: location.pathname.replace('/oidc/callback', '')
  });
};
OidcCallback.displayName = 'OidcCallback';

exports["default"] = OidcCallback;
